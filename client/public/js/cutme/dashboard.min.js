var v_hairstyle = 1
var v_hairstyleChooseId = null
var v_hairstyleChooseImage = null
var v_barberChooseId = null
var v_barberChooseImage = null
var v_price = null

function initHairstyleType(type) {
  v_hairstyle = type
  var dashboard = $("section.dashboard-content")
  if(v_hairstyle == 1) dashboard.removeClass("woman").addClass("man")
  else dashboard.removeClass("man").addClass("woman")
  initHairstyle()
}

function initHairstyleChoose(pointer) {
  pointer = $(pointer).closest(".item")
  item = pointer.closest(".owl-stage").find(".item")
  item.find(".btn-cutme").text("Choose")

  if(pointer.hasClass("chosen")){
    item.removeClass("chosen passive")
    v_hairstyleChooseId = v_hairstyleChooseImage = v_price = null
  } else {
    item.removeClass("chosen").addClass("passive")
    pointer.removeClass("passive").addClass("chosen")
    pointer.find(".btn-cutme").text("Cancel")
    v_hairstyleChooseId = pointer.attr("code")
    v_hairstyleChooseImage = pointer.find("img").attr("src")
    v_price = pointer.find("li.price").html()
  }

  initButtonOrder()
}

function initBarberChoose(pointer) {
  pointer = $(pointer).closest(".item")
  item = pointer.closest(".owl-stage").find(".item")
  item.find(".btn-cutme").text("Choose")

  if(pointer.hasClass("chosen")){
    item.removeClass("chosen passive")
    v_barberChooseId = v_barberChooseImage = null
  } else {
    item.removeClass("chosen").addClass("passive")
    pointer.removeClass("passive").addClass("chosen")
    pointer.find(".btn-cutme").text("Cancel")
    v_barberChooseId = pointer.attr("code")
    v_barberChooseImage = pointer.find("img").attr("src")
  }

  initButtonOrder()
}

function initHairstyle(){
  $.get({
    url:`http://localhost:8080/api/styles/${v_hairstyle}`,
    success:function(result){
      var hairstyle = $("#hairstyle-list")
      hairstyle.trigger('destroy.owl.carousel').removeClass('owl-carousel owl-loaded')
      hairstyle.find('.owl-stage-outer').children().unwrap()
      hairstyle.find('.item').remove()
      for(var idx = 0; idx < result.length; idx++){
        var html = `<li class="item" id="hairstyle-${idx+1}" code="${result[idx].id}"><div class="thumbnail"><img src="${result[idx].file}"><div class="caption"><div class="title row"><div class="col-xs-12"><h4>${result[idx].name}</h4></div></div><div class="action row"><div class="col-xs-6"><ul class="info"><li><i class="fa fa-star" aria-hidden="true"></i>${result[idx].rating}</li><li class="price">Rp. ${result[idx].price}</li></ul></div><div class="col-xs-6 text-right"><a href="javascript:void(0)" class="btn btn-cutme" role="button" onClick="initHairstyleChoose(this)">Choose</a></div></div></div></div></li>`
        hairstyle.append(html)
      }
      initCarousel(hairstyle)
    }
  })
}

function initBarber(){
  $.get({
    url:`http://localhost:8080/api/barbers`,
    success:function(result){
      var barber = $("#barber-list")
      barber.trigger('destroy.owl.carousel').removeClass('owl-carousel owl-loaded')
      barber.find('.owl-stage-outer').children().unwrap()
      barber.find('.item').remove()
      for(var idx = 0; idx < result.length; idx++){
        var html = `<li class="item" id="barber-${idx+1}" code="${result[idx].id}"><div class="thumbnail"><img src="${result[idx].file}"><div class="caption"><div class="title row"><div class="col-xs-12"><h4>${result[idx].name}</h4></div></div><div class="action row"><div class="col-xs-6"><ul class="info"><li><i class="fa fa-star" aria-hidden="true"></i>${result[idx].rating}</li></ul></div><div class="col-xs-6 text-right"><a href="javascript:void(0)" class="btn btn-cutme" role="button" onClick="initBarberChoose(this)">Choose</a></div></div></div></div></li>`
        barber.append(html)
      }
      initCarousel(barber)
    }
  })
}

function initButtonOrder(){
  pointer = $("#btn-order")

  if(v_hairstyleChooseId != null && v_hairstyleChooseImage != null && v_barberChooseId != null && v_barberChooseImage != null && v_price!= null){
    pointer.attr("disabled", false)
  } else {
    pointer.attr("disabled", true)
  }
}

function initConfirmOrder(){
  pointer = $("#btn-confirm-order")

  pointer.unbind().on("click", function(event){
    var session = JSON.parse(localStorage.getItem("session"))
    $.post({
      url:`http://localhost:8080/api/orders`,
      data:{
        "hairStyleId": v_hairstyleChooseId,
        "barberId": v_barberChooseId,
        "address": `(${cutmeGoogleMap["dashboard-map"].getCenter().lat()},+${cutmeGoogleMap["dashboard-map"].getCenter().lng()}&zoom=15&scale=2&size=250x250&maptype=roadmap&key=AIzaSyAbNOIdewwsnyrr9k4MdL7zlg0TQNaE_Vg&format=png&visual_refresh=true&markers=size:mid%7Ccolor:0x544ffb%7Clabel:1%7C${cutmeGoogleMap["dashboard-map"].getCenter().lat()},+${cutmeGoogleMap["dashboard-map"].getCenter().lng()})`,
        "dt_created": new Date(),
        "userId": session._id,
        "status": "BOOK",
        "imgBeforeData": canvas.toDataURL('image/jpeg')
      },
      success:function(result){
        alert("success")
      }
    })
  })
}

function initModalDashboard(pointer){
  if(v_hairstyleChooseId != null && v_hairstyleChooseImage != null && v_barberChooseId != null && v_barberChooseImage != null && v_price!= null){
    pointer = $(pointer)
    var modal = $(pointer.attr("data-target"))
    var session = JSON.parse(localStorage.getItem("session"))
    $("#modal-name").text(session.fullName)
    $("#modal-image-hairstyle").attr("src", v_hairstyleChooseImage)
    $("#modal-image-barber").attr("src", v_barberChooseImage)
    $("#modal-map").attr("src", `http://maps.googleapis.com/maps/api/staticmap?center=${cutmeGoogleMap["dashboard-map"].getCenter().lat()},+${cutmeGoogleMap["dashboard-map"].getCenter().lng()}&zoom=15&scale=2&size=250x250&maptype=roadmap&key=AIzaSyAbNOIdewwsnyrr9k4MdL7zlg0TQNaE_Vg&format=png&visual_refresh=true&markers=size:mid%7Ccolor:0x544ffb%7Clabel:1%7C${cutmeGoogleMap["dashboard-map"].getCenter().lat()},+${cutmeGoogleMap["dashboard-map"].getCenter().lng()}`)
    $("#modal-price").text(v_price)

    modal.modal("show")
    function startCam(){
      navigator.getMedia({
          video: true,
          audio: false
        },
        function(stream) {
          if (navigator.mozGetUserMedia) {
            video.mozSrcObject = stream;
          } else {
            var vendorURL = window.URL || window.webkitURL
            video.src = vendorURL.createObjectURL(stream)
          }
          video.play()
        },
        function(err) {
          console.log("An error occured! " + err)
        }
      )
    }
    startCam()
  }
}

$(function(){
  initConfirmOrder()
  initHairstyleType(1)
  initBarber()
  initButtonOrder()
})
